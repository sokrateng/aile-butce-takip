import React, { useState, useEffect } from 'react';
import { Plus, Wallet, TrendingUp, TrendingDown, Users as UsersIcon, Settings, Trash2, Edit2, ChevronLeft, ChevronRight, PieChart as PieChartIcon } from 'lucide-react';
import { format, addMonths, subMonths, startOfMonth, endOfMonth, isWithinInterval, parseISO } from 'date-fns';
import { tr } from 'date-fns/locale';
import { BarChart, Bar, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';

// Initial Data
const INITIAL_USERS = [
    { id: '1', name: 'Engin', phone: '555-0000', avatar: 'https://ui-avatars.com/api/?name=Engin&background=0D8ABC&color=fff' },
    { id: '2', name: 'Eylül', phone: '555-1111', avatar: 'https://ui-avatars.com/api/?name=Eylul&background=random' },
];

const INITIAL_CATEGORIES = {
    income: [
        { id: 'inc-1', name: 'Maaş' },
        { id: 'inc-2', name: 'Kira Geliri' },
        { id: 'inc-3', name: 'Ek İş' },
    ],
    expense: [
        { id: 'exp-1', name: 'Market' },
        { id: 'exp-2', name: 'Fatura' },
        { id: 'exp-3', name: 'Kira' },
        { id: 'exp-4', name: 'Ulaşım' },
        { id: 'exp-5', name: 'Eğlence' },
    ]
};

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658', '#ff7300'];

function App() {
    // --- STATE ---
    const [users, setUsers] = useState(() => {
        const saved = localStorage.getItem('users');
        return saved ? JSON.parse(saved) : INITIAL_USERS;
    });

    const [categories, setCategories] = useState(() => {
        const saved = localStorage.getItem('categories');
        return saved ? JSON.parse(saved) : INITIAL_CATEGORIES;
    });

    const [transactions, setTransactions] = useState(() => {
        const saved = localStorage.getItem('transactions');
        return saved ? JSON.parse(saved) : [];
    });

    // UI State
    const [activeTab, setActiveTab] = useState('dashboard'); // dashboard, settings
    const [editingTransaction, setEditingTransaction] = useState(null);
    const [currentDate, setCurrentDate] = useState(new Date());
    const [dashboardUserFilter, setDashboardUserFilter] = useState([]); // Empty array means ALL users
    const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'desc' });

    // Form State
    const [amount, setAmount] = useState('');
    const [description, setDescription] = useState('');
    const [type, setType] = useState('expense');
    const [selectedUser, setSelectedUser] = useState(users[0]?.id || '');
    const [selectedCategory, setSelectedCategory] = useState('');
    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

    // Settings Form State
    const [editingUser, setEditingUser] = useState(null);
    const [userForm, setUserForm] = useState({ name: '', phone: '' });

    const [editingCategory, setEditingCategory] = useState(null);
    const [categoryForm, setCategoryForm] = useState({ name: '', type: 'expense' });

    // --- EFFECTS ---
    useEffect(() => { localStorage.setItem('users', JSON.stringify(users)); }, [users]);
    useEffect(() => { localStorage.setItem('categories', JSON.stringify(categories)); }, [categories]);
    useEffect(() => { localStorage.setItem('transactions', JSON.stringify(transactions)); }, [transactions]);

    // --- HANDLERS: Transactions ---
    const handleAddTransaction = (e) => {
        e.preventDefault();
        if (!amount || !description || !selectedUser || !selectedCategory) return;

        if (editingTransaction) {
            const updatedTransaction = {
                ...editingTransaction,
                userId: selectedUser,
                type,
                amount: parseFloat(amount),
                description,
                category: selectedCategory,
                date,
            };
            setTransactions(transactions.map(t => t.id === editingTransaction.id ? updatedTransaction : t));
            setEditingTransaction(null);
        } else {
            const newTransaction = {
                id: Date.now().toString(),
                userId: selectedUser,
                type,
                amount: parseFloat(amount),
                description,
                category: selectedCategory,
                date,
            };
            setTransactions([newTransaction, ...transactions]);
        }
        setAmount('');
        setDescription('');
    };

    const handleEditTransactionClick = (t) => {
        setEditingTransaction(t);
        setAmount(t.amount);
        setDescription(t.description);
        setType(t.type);
        setSelectedUser(t.userId);
        setSelectedCategory(t.category);
        setDate(t.date);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const handleCancelEdit = () => {
        setEditingTransaction(null);
        setAmount('');
        setDescription('');
        setDate(new Date().toISOString().split('T')[0]);
    };

    const handleDeleteTransaction = (id) => {
        if (confirm('Bu işlemi silmek istediğinize emin misiniz?')) {
            setTransactions(transactions.filter(t => t.id !== id));
        }
    };

    // --- HANDLERS: Users ---
    const handleSaveUser = (e) => {
        e.preventDefault();
        if (!userForm.name) return;

        if (editingUser) {
            setUsers(users.map(u => u.id === editingUser.id ? { ...u, ...userForm, avatar: `https://ui-avatars.com/api/?name=${userForm.name}&background=random` } : u));
            setEditingUser(null);
        } else {
            const user = {
                id: Date.now().toString(),
                ...userForm,
                avatar: `https://ui-avatars.com/api/?name=${userForm.name}&background=random`
            };
            setUsers([...users, user]);
        }
        setUserForm({ name: '', phone: '' });
    };

    const handleEditUserClick = (user) => {
        setEditingUser(user);
        setUserForm({ name: user.name, phone: user.phone });
    };

    const handleDeleteUser = (id) => {
        if (confirm('Bu kullanıcıyı silmek istediğinize emin misiniz?')) {
            setUsers(users.filter(u => u.id !== id));
        }
    };

    // --- HANDLERS: Categories ---
    const handleSaveCategory = (e) => {
        e.preventDefault();
        if (!categoryForm.name) return;

        if (editingCategory) {
            // If type changed, remove from old list and add to new, otherwise just update
            if (editingCategory.type !== categoryForm.type) {
                setCategories(prev => ({
                    ...prev,
                    [editingCategory.type]: prev[editingCategory.type].filter(c => c.id !== editingCategory.id),
                    [categoryForm.type]: [...prev[categoryForm.type], { id: editingCategory.id, name: categoryForm.name }]
                }));
            } else {
                setCategories(prev => ({
                    ...prev,
                    [categoryForm.type]: prev[categoryForm.type].map(c => c.id === editingCategory.id ? { ...c, name: categoryForm.name } : c)
                }));
            }
            setEditingCategory(null);
        } else {
            const category = { id: Date.now().toString(), name: categoryForm.name };
            setCategories(prev => ({
                ...prev,
                [categoryForm.type]: [...prev[categoryForm.type], category]
            }));
        }
        setCategoryForm(prev => ({ ...prev, name: '' }));
    };

    const handleEditCategoryClick = (cat, type) => {
        setEditingCategory({ ...cat, type });
        setCategoryForm({ name: cat.name, type });
    };

    const handleDeleteCategory = (catType, id) => {
        if (confirm('Bu kategoriyi silmek istediğinize emin misiniz?')) {
            setCategories(prev => ({
                ...prev,
                [catType]: prev[catType].filter(c => c.id !== id)
            }));
        }
    };

    // --- CALCULATIONS & FILTERING ---
    const monthStart = startOfMonth(currentDate);
    const monthEnd = endOfMonth(currentDate);

    const filteredTransactions = transactions.filter(t =>
        isWithinInterval(parseISO(t.date), { start: monthStart, end: monthEnd }) &&
        (dashboardUserFilter.length === 0 || dashboardUserFilter.includes(t.userId))
    );

    const sortedTransactions = [...filteredTransactions].sort((a, b) => {
        if (sortConfig.key === 'amount') {
            return sortConfig.direction === 'asc' ? a.amount - b.amount : b.amount - a.amount;
        }
        if (sortConfig.key === 'date') {
            return sortConfig.direction === 'asc' ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date);
        }
        if (sortConfig.key === 'userId') {
            const nameA = users.find(u => u.id === a.userId)?.name || '';
            const nameB = users.find(u => u.id === b.userId)?.name || '';
            return sortConfig.direction === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
        }
        // String comparison for other fields
        const valA = a[sortConfig.key] ? a[sortConfig.key].toString().toLowerCase() : '';
        const valB = b[sortConfig.key] ? b[sortConfig.key].toString().toLowerCase() : '';
        return sortConfig.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
    });

    const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((acc, c) => acc + c.amount, 0);
    const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((acc, c) => acc + c.amount, 0);
    const balance = totalIncome - totalExpense;

    const userStats = users.map(user => {
        const userTrans = filteredTransactions.filter(t => t.userId === user.id);
        const income = userTrans.filter(t => t.type === 'income').reduce((acc, c) => acc + c.amount, 0);
        const expense = userTrans.filter(t => t.type === 'expense').reduce((acc, c) => acc + c.amount, 0);
        return { ...user, income, expense, balance: income - expense };
    });

    // Chart Data: Monthly Comparison (Last 4 Months)
    const monthlyComparisonData = [];
    for (let i = 3; i >= 0; i--) {
        const targetDate = subMonths(currentDate, i);
        const start = startOfMonth(targetDate);
        const end = endOfMonth(targetDate);

        const monthTrans = transactions.filter(t =>
            isWithinInterval(parseISO(t.date), { start, end }) &&
            (dashboardUserFilter.length === 0 || dashboardUserFilter.includes(t.userId))
        );

        const income = monthTrans.filter(t => t.type === 'income').reduce((acc, c) => acc + c.amount, 0);
        const expense = monthTrans.filter(t => t.type === 'expense').reduce((acc, c) => acc + c.amount, 0);

        monthlyComparisonData.push({
            name: format(targetDate, 'MMMM', { locale: tr }),
            gelir: income,
            gider: expense
        });
    }

    // Chart Data: Category Pie Charts
    const getCategoryData = (type) => {
        const data = filteredTransactions
            .filter(t => t.type === type)
            .reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});
        return Object.entries(data).map(([name, value]) => ({ name, value }));
    };

    const incomeCategoryData = getCategoryData('income');
    const expenseCategoryData = getCategoryData('expense');

    return (
        <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans text-gray-800">
            <div className="max-w-7xl mx-auto space-y-6">

                {/* Header */}
                <header className="flex flex-col md:flex-row items-center justify-between bg-white p-6 rounded-2xl shadow-sm gap-4">
                    <div className="flex items-center gap-3 w-full md:w-auto">
                        <div className="bg-blue-600 p-3 rounded-xl text-white">
                            <Wallet size={24} />
                        </div>
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Aile Bütçesi</h1>
                            <p className="text-gray-500 text-sm">Harcamalarınızı kontrol altına alın</p>
                        </div>
                    </div>

                    {activeTab === 'dashboard' && (
                        <div className="flex items-center bg-gray-100 rounded-lg p-1">
                            <button onClick={() => setCurrentDate(subMonths(currentDate, 1))} className="p-2 hover:bg-white rounded-md transition-all"><ChevronLeft size={20} /></button>
                            <span className="px-4 font-medium min-w-[140px] text-center">{format(currentDate, 'MMMM yyyy', { locale: tr })}</span>
                            <button onClick={() => setCurrentDate(addMonths(currentDate, 1))} className="p-2 hover:bg-white rounded-md transition-all"><ChevronRight size={20} /></button>
                        </div>
                    )}

                    <div className="flex items-center gap-4 w-full md:w-auto justify-end">
                        <button
                            onClick={() => setActiveTab(activeTab === 'dashboard' ? 'settings' : 'dashboard')}
                            className={`p-2 rounded-lg transition-colors ${activeTab === 'settings' ? 'bg-blue-100 text-blue-600' : 'text-gray-500 hover:bg-gray-100'}`}
                        >
                            <Settings size={24} />
                        </button>
                        <div className="text-right hidden sm:block">
                            <p className="text-sm text-gray-500">Toplam Bakiye</p>
                            <p className={`text-2xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                {balance.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}
                            </p>
                        </div>
                    </div>
                </header>

                {activeTab === 'dashboard' ? (
                    <>
                        {/* User Filter */}
                        <div className="flex items-center gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
                            <button
                                onClick={() => setDashboardUserFilter([])}
                                className={`px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap ${dashboardUserFilter.length === 0 ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50 shadow-sm'}`}
                            >
                                Tümü
                            </button>
                            {users.map(user => (
                                <button
                                    key={user.id}
                                    onClick={() => {
                                        if (dashboardUserFilter.includes(user.id)) {
                                            const newFilter = dashboardUserFilter.filter(id => id !== user.id);
                                            setDashboardUserFilter(newFilter); // If empty, it naturally becomes "All"
                                        } else {
                                            setDashboardUserFilter([...dashboardUserFilter, user.id]);
                                        }
                                    }}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap ${dashboardUserFilter.includes(user.id) ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50 shadow-sm'}`}
                                >
                                    <img src={user.avatar} className="w-5 h-5 rounded-full" alt="" />
                                    {user.name}
                                </button>
                            ))}
                        </div>

                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-white p-6 rounded-2xl shadow-sm flex items-center gap-4">
                                <div className="bg-green-100 p-3 rounded-full text-green-600"><TrendingUp size={24} /></div>
                                <div>
                                    <p className="text-sm text-gray-500">Dönem Geliri</p>
                                    <p className="text-2xl font-bold text-green-600">{totalIncome.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</p>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm flex items-center gap-4">
                                <div className="bg-red-100 p-3 rounded-full text-red-600"><TrendingDown size={24} /></div>
                                <div>
                                    <p className="text-sm text-gray-500">Dönem Gideri</p>
                                    <p className="text-2xl font-bold text-red-600">{totalExpense.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</p>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm flex items-center gap-4">
                                <div className="bg-blue-100 p-3 rounded-full text-blue-600"><UsersIcon size={24} /></div>
                                <div>
                                    <p className="text-sm text-gray-500">Kişi Sayısı</p>
                                    <p className="text-2xl font-bold text-blue-600">{users.length}</p>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Column */}
                            <div className="space-y-6 lg:col-span-1">
                                {/* Add Transaction Form */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                                        {editingTransaction ? <Edit2 size={20} /> : <Plus size={20} />}
                                        {editingTransaction ? 'İşlem Düzenle' : 'İşlem Ekle'}
                                    </h2>
                                    <form onSubmit={handleAddTransaction} className="space-y-4">
                                        <div className="flex bg-gray-100 p-1 rounded-lg">
                                            <button type="button" onClick={() => setType('income')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${type === 'income' ? 'bg-green-500 text-white shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Gelir</button>
                                            <button type="button" onClick={() => setType('expense')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${type === 'expense' ? 'bg-red-500 text-white shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Gider</button>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Kişi</label>
                                            <select value={selectedUser} onChange={(e) => setSelectedUser(e.target.value)} className="w-full p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                                {users.map(user => <option key={user.id} value={user.id}>{user.name}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                                            <select value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)} className="w-full p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                                <option value="">Seçiniz</option>
                                                {categories[type].map(cat => <option key={cat.id} value={cat.name}>{cat.name}</option>)}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Tutar (TL)</label>
                                            <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="w-full p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                                            <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Açıklama giriniz" className="w-full p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Tarih</label>
                                            <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required />
                                        </div>

                                        <div className="flex gap-2">
                                            {editingTransaction && (
                                                <button type="button" onClick={handleCancelEdit} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">İptal</button>
                                            )}
                                            <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                                {editingTransaction ? 'Güncelle' : 'Ekle'}
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                {/* User Summaries */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm">
                                    <h2 className="text-lg font-bold mb-4">Kişi Bazlı Durum (Bu Ay)</h2>
                                    <div className="space-y-4">
                                        {userStats.map(user => (
                                            <div key={user.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                                <div className="flex items-center gap-3">
                                                    <img src={user.avatar} alt={user.name} className="w-10 h-10 rounded-full" />
                                                    <div>
                                                        <p className="font-medium text-gray-900">{user.name}</p>
                                                        <p className="text-xs text-gray-500">
                                                            <span className="text-green-600">+{user.income.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}</span> | <span className="text-red-600">-{user.expense.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}</span>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className={`font-bold ${user.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {user.balance.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Right Column */}
                            <div className="space-y-6 lg:col-span-2">

                                {/* Charts Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Income Pie */}
                                    <div className="bg-white p-6 rounded-2xl shadow-sm">
                                        <h2 className="text-sm font-bold mb-4 text-gray-500 uppercase tracking-wider">Gelir Dağılımı</h2>
                                        <div className="h-48 w-full">
                                            {incomeCategoryData.length > 0 ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie data={incomeCategoryData} cx="50%" cy="50%" innerRadius={30} outerRadius={60} paddingAngle={5} dataKey="value">
                                                            {incomeCategoryData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                                        </Pie>
                                                        <Tooltip formatter={(value) => value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })} />
                                                        <Legend wrapperStyle={{ fontSize: '12px' }} />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            ) : <div className="h-full flex items-center justify-center text-gray-400 text-sm">Veri yok</div>}
                                        </div>
                                    </div>

                                    {/* Expense Pie */}
                                    <div className="bg-white p-6 rounded-2xl shadow-sm">
                                        <h2 className="text-sm font-bold mb-4 text-gray-500 uppercase tracking-wider">Gider Dağılımı</h2>
                                        <div className="h-48 w-full">
                                            {expenseCategoryData.length > 0 ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie data={expenseCategoryData} cx="50%" cy="50%" innerRadius={30} outerRadius={60} paddingAngle={5} dataKey="value">
                                                            {expenseCategoryData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                                        </Pie>
                                                        <Tooltip formatter={(value) => value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })} />
                                                        <Legend wrapperStyle={{ fontSize: '12px' }} />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            ) : <div className="h-full flex items-center justify-center text-gray-400 text-sm">Veri yok</div>}
                                        </div>
                                    </div>
                                </div>

                                {/* Bar Chart */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm">
                                    <h2 className="text-lg font-bold mb-4">Aylık Karşılaştırma (Son 4 Dönem)</h2>
                                    <div className="h-64 w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={monthlyComparisonData}>
                                                <XAxis dataKey="name" />
                                                <YAxis tickFormatter={(value) => value.toLocaleString('tr-TR')} />
                                                <Tooltip formatter={(value) => value.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })} />
                                                <Legend />
                                                <Bar dataKey="gelir" fill="#10B981" name="Gelir" radius={[4, 4, 0, 0]} />
                                                <Bar dataKey="gider" fill="#EF4444" name="Gider" radius={[4, 4, 0, 0]} />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                                {/* Recent Transactions */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm">
                                    <h2 className="text-lg font-bold mb-4">Bu Ayın İşlemleri</h2>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="border-b border-gray-100 text-gray-500 text-sm">
                                                    <th className="pb-3 font-medium cursor-pointer hover:text-gray-700" onClick={() => setSortConfig({ key: 'userId', direction: sortConfig.key === 'userId' && sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                        Kişi {sortConfig.key === 'userId' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th className="pb-3 font-medium cursor-pointer hover:text-gray-700" onClick={() => setSortConfig({ key: 'category', direction: sortConfig.key === 'category' && sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                        Kategori {sortConfig.key === 'category' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th className="pb-3 font-medium cursor-pointer hover:text-gray-700" onClick={() => setSortConfig({ key: 'description', direction: sortConfig.key === 'description' && sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                        Açıklama {sortConfig.key === 'description' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th className="pb-3 font-medium cursor-pointer hover:text-gray-700" onClick={() => setSortConfig({ key: 'date', direction: sortConfig.key === 'date' && sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                        Tarih {sortConfig.key === 'date' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th className="pb-3 font-medium text-right cursor-pointer hover:text-gray-700" onClick={() => setSortConfig({ key: 'amount', direction: sortConfig.key === 'amount' && sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                        Tutar {sortConfig.key === 'amount' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th className="pb-3 font-medium w-20"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm">
                                                {sortedTransactions.length === 0 ? (
                                                    <tr><td colSpan="6" className="py-8 text-center text-gray-400">Bu dönemde işlem yok</td></tr>
                                                ) : (
                                                    sortedTransactions.map(t => {
                                                        const user = users.find(u => u.id === t.userId);
                                                        return (
                                                            <tr key={t.id} className="border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors group">
                                                                <td className="py-3 flex items-center gap-2">
                                                                    <img src={user?.avatar} className="w-6 h-6 rounded-full" alt="" />
                                                                    <span className="text-gray-900">{user?.name}</span>
                                                                </td>
                                                                <td className="py-3 text-gray-600"><span className="bg-gray-100 px-2 py-1 rounded text-xs">{t.category}</span></td>
                                                                <td className="py-3 text-gray-600">{t.description}</td>
                                                                <td className="py-3 text-gray-500">{format(parseISO(t.date), 'd MMM', { locale: tr })}</td>
                                                                <td className={`py-3 text-right font-medium ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>
                                                                    {t.type === 'income' ? '+' : '-'}{t.amount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}
                                                                </td>
                                                                <td className="py-3 text-right">
                                                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                        <button onClick={() => handleEditTransactionClick(t)} className="p-1 text-blue-500 hover:bg-blue-100 rounded"><Edit2 size={16} /></button>
                                                                        <button onClick={() => handleDeleteTransaction(t.id)} className="p-1 text-red-500 hover:bg-red-100 rounded"><Trash2 size={16} /></button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </>
                ) : (
                    // SETTINGS TAB
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* User Management */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm">
                            <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><UsersIcon size={20} /> Kullanıcı Yönetimi</h2>
                            <form onSubmit={handleSaveUser} className="mb-6 space-y-3 bg-gray-50 p-4 rounded-xl">
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="text" placeholder="İsim" value={userForm.name} onChange={e => setUserForm({ ...userForm, name: e.target.value })} className="p-2 border rounded-lg" required />
                                    <input type="text" placeholder="Telefon" value={userForm.phone} onChange={e => setUserForm({ ...userForm, phone: e.target.value })} className="p-2 border rounded-lg" />
                                </div>
                                <div className="flex gap-2">
                                    {editingUser && <button type="button" onClick={() => { setEditingUser(null); setUserForm({ name: '', phone: '' }); }} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">İptal</button>}
                                    <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">{editingUser ? 'Güncelle' : 'Kullanıcı Ekle'}</button>
                                </div>
                            </form>
                            <div className="space-y-2">
                                {users.map(user => (
                                    <div key={user.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl group">
                                        <div className="flex items-center gap-3">
                                            <img src={user.avatar} className="w-8 h-8 rounded-full" alt="" />
                                            <div>
                                                <p className="font-medium">{user.name}</p>
                                                <p className="text-xs text-gray-500">{user.phone || 'Tel yok'}</p>
                                            </div>
                                        </div>
                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => handleEditUserClick(user)} className="p-1 text-blue-500 hover:bg-blue-100 rounded"><Edit2 size={16} /></button>
                                            <button onClick={() => handleDeleteUser(user.id)} className="p-1 text-red-500 hover:bg-red-100 rounded"><Trash2 size={16} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Category Management */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm">
                            <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Settings size={20} /> Kategori Yönetimi</h2>
                            <form onSubmit={handleSaveCategory} className="mb-6 space-y-3 bg-gray-50 p-4 rounded-xl">
                                <div className="flex gap-2">
                                    <select value={categoryForm.type} onChange={e => setCategoryForm({ ...categoryForm, type: e.target.value })} className="p-2 border rounded-lg">
                                        <option value="income">Gelir</option>
                                        <option value="expense">Gider</option>
                                    </select>
                                    <input type="text" placeholder="Kategori Adı" value={categoryForm.name} onChange={e => setCategoryForm({ ...categoryForm, name: e.target.value })} className="flex-1 p-2 border rounded-lg" required />
                                </div>
                                <div className="flex gap-2">
                                    {editingCategory && <button type="button" onClick={() => { setEditingCategory(null); setCategoryForm({ name: '', type: 'expense' }); }} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">İptal</button>}
                                    <button type="submit" className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">{editingCategory ? 'Güncelle' : 'Kategori Ekle'}</button>
                                </div>
                            </form>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <h3 className="font-medium text-green-600 mb-2">Gelir Kategorileri</h3>
                                    <div className="space-y-2">
                                        {categories.income.map(cat => (
                                            <div key={cat.id} className="flex justify-between items-center p-2 bg-green-50 rounded-lg text-sm group">
                                                <span>{cat.name}</span>
                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => handleEditCategoryClick(cat, 'income')} className="text-blue-400 hover:text-blue-600"><Edit2 size={14} /></button>
                                                    <button onClick={() => handleDeleteCategory('income', cat.id)} className="text-red-400 hover:text-red-600"><Trash2 size={14} /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="font-medium text-red-600 mb-2">Gider Kategorileri</h3>
                                    <div className="space-y-2">
                                        {categories.expense.map(cat => (
                                            <div key={cat.id} className="flex justify-between items-center p-2 bg-red-50 rounded-lg text-sm group">
                                                <span>{cat.name}</span>
                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => handleEditCategoryClick(cat, 'expense')} className="text-blue-400 hover:text-blue-600"><Edit2 size={14} /></button>
                                                    <button onClick={() => handleDeleteCategory('expense', cat.id)} className="text-red-400 hover:text-red-600"><Trash2 size={14} /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

export default App;
